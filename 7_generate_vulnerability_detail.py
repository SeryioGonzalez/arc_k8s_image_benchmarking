from itertools import chain

import config
import json
import os
import re
import sys

def load_json_file(json_file):
    file_pointer = open(json_file)
    json_data    = json.load(file_pointer)

    return json_data

def process_results_json(results_json):
    
    filtered_data_vulnerability_list = []

    found_vulnerabilities_all_data = [result['Vulnerabilities'] for result in results_json if 'Vulnerabilities' in result.keys()]
    
    for vulnerabilities in found_vulnerabilities_all_data:
        for vulnerability in vulnerabilities:
            vulnerability_data_dict = {}
            vulnerability_data_dict['VulnerabilityID'] = vulnerability['VulnerabilityID']
            vulnerability_data_dict['Severity']        = vulnerability['Severity']
            vulnerability_data_dict['PrimaryURL']      = vulnerability['PrimaryURL']

            filtered_data_vulnerability_list.append(vulnerability_data_dict)

    return filtered_data_vulnerability_list

image_scan_all_data      = [ load_json_file(os.path.join(config.image_scan_folder, image_scan_file)) for image_scan_file in os.listdir(config.image_scan_folder) if "json" in image_scan_file]
image_scan_filtered_data = [ {'image_url': one_image_scan_all_data['ArtifactName'], 'scan_results': process_results_json(one_image_scan_all_data['Results']) } for one_image_scan_all_data in image_scan_all_data ]

print("IMAGE FQDN; VULNERABILITY ID; SEVERITY; VULNERABILITY URL")

for image_scan in image_scan_filtered_data:
    image_url    = image_scan['image_url']
    scan_results = image_scan['scan_results']

    for scan_result in scan_results:
        vulnerability_id       = scan_result['VulnerabilityID']
        vulnerability_severity = scan_result['Severity']
        vulnerability_url      = scan_result['PrimaryURL']
        
        output_string = "{}; {}; {}; {}".format(image_url, vulnerability_id, vulnerability_severity, vulnerability_url)
        
        print(output_string)

